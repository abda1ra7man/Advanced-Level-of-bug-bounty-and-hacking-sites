# اختبار الـ API

# Overview

### اختبار الـ API

الـ APIs (واجهات برمجة التطبيقات) بتخلّي الأنظمة والتطبيقات تتواصل مع بعض وتشارك البيانات. اختبار الـ API مهم جدًا لأن أي ثغرات فيه ممكن تدمّر أمان وخصوصية الموقع.

كل المواقع الديناميكية بتعتمد على الـ APIs، وعشان كده، أي ثغرات تقليدية زي SQL Injection ممكن تبقى جزء من اختبار الـ API. في الموضوع ده، هنتعلم إزاي نختبر الـ APIs اللي مش مستخدمة بالكامل في الواجهة الأمامية للموقع، مع التركيز على RESTful و JSON APIs، وكمان هنشوف إزاي نختبر ثغرات زي Server-side Parameter Pollution اللي ممكن تأثر على الـ APIs الداخلية.

علشان نوضّح العلاقة بين اختبار الـ API واختبار أمان المواقع بشكل عام، هنقدّم مقارنة بين المواضيع اللي هنشرحها وبين قائمة OWASP API Security Top 10 لسنة 2023.

# API recon

### استكشاف الـ API

قبل ما تبدأ في اختبار الـ API، لازم تجمع أكبر قدر ممكن من المعلومات عنه علشان تقدر تحدد نقاط الضعف اللي ممكن تستغلها.

#### تحديد الـ API Endpoints

نقاط النهاية (Endpoints) هي الأماكن اللي بيستقبل فيها الـ API الطلبات الخاصة بالموارد على السيرفر. مثال على طلب GET:
```
GET /api/books HTTP/1.1
Host: example.com
```

الـ Endpoint هنا هو `/api/books`، واللي بيستدعي قائمة الكتب المتاحة في المكتبة. مثال تاني:
```
GET /api/books/mystery
```

ده هيستدعي قائمة الكتب الغامضة فقط.

#### التفاعل مع الـ API

بمجرد ما تحدد الـ Endpoints، لازم تفهم إزاي تتعامل معاها وتبعت طلبات صحيحة للاختبار. لازم تعرف:
- نوع البيانات اللي الـ API بيعالجها، سواء كانت إلزامية أو اختيارية.
- أنواع الطلبات اللي بيقبلها الـ API زي GET, POST, PUT, DELETE.
- حدود الاستخدام (Rate Limits) وأنظمة المصادقة (Authentication).

# API documentation

### مستندات الـ API

الـ APIs بيكون ليها مستندات بتوضح للمطورين إزاي يستخدموها ويتكاملوا معاها. المستندات دي نوعين:
- **مقروءة للبشر**: بتحتوي على شرح تفصيلي، أمثلة، وسيناريوهات استخدام.
- **مقروءة آليًا**: بتكون بتنسيقات زي JSON أو XML، وبتستخدم في الأتمتة والاختبار.

في بعض الأحيان، مستندات الـ API بتكون متاحة للعامة، وده بيكون مفيد جدًا عند البحث عن نقاط الضعف.

## Discovering API documentation

حتى لو مستندات الـ API مش متاحة للعامة، ممكن تلاقيها من خلال تحليل التطبيقات اللي بتستخدمه. 

#### طرق البحث عن المستندات:
- استخدام **Burp Scanner** لفحص الـ API واكتشاف أي مستندات غير معلنة.
- تصفح التطبيقات يدويًا باستخدام **Burp's browser**.
- البحث عن مسارات قد تحتوي على المستندات، زي:
  ```
  /api
  /swagger/index.html
  /openapi.json
  ```

لو لقيت مسار مرتبط بمصدر معين زي `/api/swagger/v1/users/123`، جرب مسارات مشابهة:
```
/api/swagger/v1
/api/swagger
/api
```

كمان تقدر تستخدم قوائم المسارات الشائعة مع **Intruder** لاكتشاف مستندات إضافية.

## Using machine-readable API documentation

تقدر تحلل المستندات الآلية باستخدام أدوات متخصصة:
- **Burp Scanner** لفحص مستندات OpenAPI.
- **OpenAPI Parser BApp** لتحليل وتدقيق المستندات.
- **Postman أو SoapUI** لاختبار الـ API مباشرة باستخدام المستندات المتاحة.

# Identifying API endpoints

## Interacting with API endpoints

### التفاعل مع الـ API Endpoints

بعد ما تحدد الـ API Endpoints، لازم تتفاعل معاها باستخدام أدوات زي **Burp Repeater** و **Burp Intruder**. الأدوات دي بتساعدك في تحليل استجابة الـ API وكشف نقاط ضعف إضافية. على سبيل المثال، ممكن تختبر استجابة الـ API عند تغيير **طريقة الطلب (HTTP Method)** أو **نوع البيانات (Media Type)**.

### تحليل استجابات الـ API

وأنت بتتعامل مع الـ API، راقب رسائل الخطأ والردود بعناية، لأن أحيانًا ممكن تحتوي على معلومات مفيدة تساعدك في تكوين طلبات HTTP صحيحة.

### تحديد طرق HTTP المدعومة

طريقة HTTP بتحدد الإجراء اللي هيتم على المورد. بعض الطرق الشائعة:

- **GET** - لاسترجاع البيانات.
- **PATCH** - لتعديل جزء من البيانات.
- **OPTIONS** - لمعرفة الطرق المدعومة من الـ API.

بعض الـ API Endpoints بتدعم أكتر من طريقة، وده معناه إنك لازم تختبر كل الطرق المحتملة علشان تكشف أي وظائف إضافية.

#### مثال على API Endpoints متعددة الوظائف:
```
GET /api/tasks - لاسترجاع قائمة المهام.
POST /api/tasks - لإنشاء مهمة جديدة.
DELETE /api/tasks/1 - لحذف مهمة.
```

ممكن تستخدم **Burp Intruder** لتجربة كل طرق HTTP المتاحة تلقائيًا.

### ملاحظة

لما تجرب طرق HTTP مختلفة، استهدف الكائنات ذات الأولوية المنخفضة علشان تتجنب أي تأثير غير مقصود، زي حذف بيانات مهمة أو إنشاء سجلات غير ضرورية.

### تحديد أنواع المحتوى المدعومة

بعض الـ API Endpoints بتتوقع بيانات بصيغة معينة، وده بيأثر على استجابتها. تغيير نوع المحتوى ممكن يساعدك في:
- **إثارة أخطاء تكشف معلومات مفيدة.**
- **تجاوز دفاعات ضعيفة.**
- **استغلال اختلافات في معالجة البيانات.**

على سبيل المثال، ممكن يكون الـ API آمن عند التعامل مع **JSON** لكنه ضعيف أمام **XML Injection**.

#### كيفية تغيير نوع المحتوى:
- عدّل الهيدر `Content-Type`.
- أعد تنسيق جسم الطلب حسب النوع الجديد.
- استخدم **Content Type Converter BApp** لتحويل البيانات بين **XML و JSON** تلقائيًا.


## Finding hidden parameters

## Preventing vulnerabilities in APIs

## Server-side parameter pollution
### Testing the query string
#### Truncating query strings
#### Injecting invalid parameters
#### Injecting valid parameters
#### Overriding existing parameters
### Testing REST paths
### Testing structured data formats
### Testing with automated tools
### Preventing server-side parameter pollution

## Alignment with the OWASP Top 10 API vulnerabilities

## View all API testing labs

