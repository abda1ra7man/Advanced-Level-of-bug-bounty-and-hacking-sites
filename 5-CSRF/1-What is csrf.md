# **Cross-site request forgery (CSRF)**

في الجزء ده، هنشرح يعني إيه **Cross-Site Request Forgery (CSRF)**، وهنعرض بعض الأمثلة على الثغرات الشائعة ليه، وكمان إزاي تمنع الهجوم ده.

## **إيه هو CSRF؟**

**CSRF** أو **تزوير الطلبات عبر المواقع** هو ثغرة أمنية في الويب بتسمح للمهاجم إنه يجبر المستخدمين على تنفيذ عمليات من غير ما يكونوا قاصدين يعملوها. ده بيدّي المهاجم القدرة على تخطي سياسة **Same-Origin Policy** اللي المفروض تمنع المواقع المختلفة من التأثير على بعضها.

```plaintext
https://vulnerable-website.com/email/change?email=pwned@evil-user.net
```

---

## **Labs**

لو عندك فكرة كويسة عن أساسيات **CSRF** وعايز تتمرن على استغلالها في أهداف ضعيفة بشكل متعمد، تقدر تلاقي كل المعامل الخاصة بالموضوع من اللينك تحت:

🔗 [**عرض كل معامل CSRF**](https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf)

---
## **إيه تأثير هجوم CSRF؟**

لو الهجوم نجح، المهاجم يقدر يخلي الضحية تنفذ عمليات من غير ما تقصد، زي:

- **تغيير البريد الإلكتروني** في الحساب.
- **تغيير كلمة المرور.**
- **تحويل أموال.**

على حسب نوع العملية، المهاجم ممكن يسيطر بالكامل على حساب المستخدم. ولو كان الحساب اللي تم اختراقه ليه صلاحيات كبيرة، فالمهاجم ممكن يتحكم في كل بيانات ووظائف التطبيق.

---

## **إزاي بيشتغل CSRF؟**

عشان يحصل هجوم CSRF، لازم تتوفر ٣ شروط أساسية:

- **وجود إجراء مهم (Relevant Action):** لازم يكون فيه عملية داخل التطبيق يقدر المهاجم يجبر الضحية على تنفيذها، زي تغيير الصلاحيات أو تعديل البيانات الخاصة بالمستخدم.

- **الاعتماد على الجلسات بالكوكيز (Cookie-based session handling):** الهجوم بيتم عن طريق إرسال طلبات HTTP، والتطبيق بيستخدم الكوكيز للتعرف على المستخدم بدون أي آلية تحقق إضافية.

- **عدم وجود متغيرات غير متوقعة في الطلب (No unpredictable request parameters):** الطلبات اللي بتنفيذ العمليات ما يكونش فيها متغيرات لازم المهاجم يعرفها مسبقًا، زي الباسورد القديم قبل تغييره.

---
## **مثال على هجوم CSRF**

لو التطبيق فيه وظيفة بتسمح للمستخدم إنه يغير الإيميل بتاعه، فممكن يتم تنفيذ طلب HTTP بالشكل ده:

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=ytvhwsztyeQkAPzeQ5gHgTvlyxHfsAfE

e-mail=wiener@normal-user.com
```

### **ليه الطلب ده معرض لـ CSRF؟**

- تغيير البريد الإلكتروني بيكون هدف مهم للمهاجم لأنه ممكن يستغله في إعادة تعيين كلمة المرور والسيطرة على الحساب بالكامل.
- التطبيق بيعتمد على **كوكي الجلسة (Session Cookie)** لتحديد هوية المستخدم، بدون أي رموز حماية إضافية.
- المهاجم يقدر يتوقع أو يحدد القيم اللي محتاجها عشان ينفذ الطلب بنجاح.

### **إزاي المهاجم يستغل الثغرة؟**

المهاجم ممكن يبني صفحة ويب بتنفيذ الطلب ده تلقائيًا:

```html
<html>
<body>
    <form action="https://vulnerable-website.com/email/change" method="POST">
        <input type="hidden" name="email" value="pwned@evil-user.net">
    </form>
    <script>
        document.forms[0].submit();
    </script>
</body>
</html>
```

### **إيه اللي هيحصل لو الضحية فتح صفحة المهاجم؟**

- الصفحة الخبيثة هتنفذ **طلب HTTP تلقائيًا** للموقع المستهدف.
- لو المستخدم **مسجل دخول**، المتصفح هيضيف كوكي الجلسة تلقائيًا في الطلب.
- الموقع المستهدف هيعتبر الطلب طبيعي وهيغير الإيميل بتاع الضحية بدون علمه.

🚨 **الحل:** لازم يتم استخدام **CSRF tokens** مع كل الطلبات الحساسة لتجنب الهجوم ده.

## **ملاحظة**

على الرغم من أن CSRF عادةً بيتم شرحه في سياق **إدارة الجلسات باستخدام الكوكيز**، إلا إنه ممكن يحصل في سيناريوهات تانية زي **المصادقة عبر HTTP Basic Authentication** أو **المصادقة باستخدام الشهادات الرقمية.**

---

## **إزاي تنشئ هجوم CSRF؟**

كتابة كود HTML يدويًا لاستغلال **CSRF** ممكن يكون مجهد، خاصةً لو الطلب المطلوب يحتوي على عدد كبير من **المعاملات (Parameters)** أو لو فيه تعقيدات تانية. أسهل طريقة لإنشاء هجوم CSRF هي استخدام **مولّد CSRF PoC** المدمج في **Burp Suite Professional**:

1. اختر أي طلب HTTP داخل **Burp Suite Professional** اللي عايز تجربه أو تستغله.
2. من **القائمة بالزر الأيمن**، اختار **Engagement tools > Generate CSRF PoC**.
3. **Burp Suite** هيولّد كود HTML جاهز ينفذ الطلب اللي اخترته (باستثناء الكوكيز اللي هيتم إضافتها تلقائيًا من متصفح الضحية).
4. تقدر تعدّل بعض الإعدادات في **مولّد CSRF PoC** لضبط بعض التفاصيل الدقيقة للهجوم.
5. انسخ كود **HTML** المُولَّد، وحطه في صفحة ويب، ثم افتحها في متصفح يكون المستخدم **مسجل دخول فيه للموقع المستهدف**، وشوف إذا كان الطلب هيتم تنفيذه بنجاح ولا لأ.

---

## **المعمل التدريبي** 🧪
🔗 **[تجربة استغلال ثغرة CSRF بدون حماية](https://portswigger.net/web-security/csrf/lab-no-defenses)**

---
## **إزاي توصل استغلال CSRF؟**

آلية تنفيذ **هجمات CSRF** بتكون شبيهة جدًا بـ **الهجمات العاكسة (Reflected XSS)**. في العادة، المهاجم بيضيف **كود HTML خبيث** في موقع هو بيتحكم فيه، وبعدها بيحاول يجذب الضحايا لزيارة الموقع ده.

📌 **طرق جذب الضحايا:**
- إرسال رابط للموقع المصاب عبر **البريد الإلكتروني** أو **وسائل التواصل الاجتماعي**.
- نشر الهجوم في **موقع شهير** زي خانة التعليقات، وانتظار الزوار للدخول.

### **استغلال CSRF باستخدام GET**

بعض هجمات **CSRF البسيطة** بتستخدم **طريقة GET**، وبتكون مكتفية بعنوان URL واحد على الموقع المستهدف، بدون الحاجة لموقع خارجي.

📌 في الحالة دي، المهاجم يقدر يرسل رابط خبيث مباشرةً للضحية على **الموقع الضعيف** نفسه.

### **مثال على هجوم GET:**

```html
<img src="https://vulnerable-website.com/email/change?email=pwned@evil-user.net">
```

-هنا يقصد لو الضحية فتح موقع فيه صورة مثلا وفيها اللينك ده في الصورة فهيغير الايميل مثلا او كلمة السر بدون عمله 

🔗 **[اقرأ أكثر عن الفرق بين XSS و CSRF](https://portswigger.net/web-security/csrf/xss-vs-csrf)**

---
## **أهم وسائل الحماية ضد CSRF**

في الوقت الحالي، استغلال ثغرات **CSRF** أصبح يتطلب تجاوز وسائل الحماية المطبّقة من قبل الموقع المستهدف أو متصفح الضحية أو كليهما. من أهم وسائل الحماية التي قد تواجهها:

### **🔹 CSRF Tokens**
- **وصف:** هو رمز **سري، فريد، وغير متوقع** يتم إنشاؤه من جهة الخادم ومشاركته مع العميل.
- **طريقة الحماية:** عند تنفيذ عملية حساسة مثل إرسال نموذج، يجب على العميل تضمين **CSRF Token** الصحيح مع الطلب، مما يجعل من الصعب جدًا على المهاجم إنشاء طلب صالح نيابة عن الضحية.

### **🔹 SameSite Cookies**
- **وصف:** آلية أمان في المتصفح تحدد متى يتم تضمين ملفات تعريف الارتباط الخاصة بالموقع عند تنفيذ الطلبات من مواقع أخرى.
- **طريقة الحماية:** عند تنفيذ عمليات حساسة تتطلب **كوكي الجلسة**، فإن تفعيل **قيود SameSite** قد يمنع المهاجم من تنفيذ الطلبات عبر المواقع.
- **معلومة هامة:** منذ عام **2021**، متصفح **Chrome** يفرض بشكل افتراضي وضع **Lax** لـ **SameSite Cookies**، ومن المتوقع أن تعتمد المتصفحات الأخرى هذا السلوك مستقبلًا.

### **🔹 Referer-based Validation**
- **وصف:** بعض التطبيقات تعتمد على **HTTP Referer Header** لمحاولة منع هجمات CSRF.
- **طريقة الحماية:** يتم التحقق مما إذا كان الطلب صادرًا من نفس **نطاق التطبيق**.
- **فعاليته:** هذه الطريقة **أقل كفاءة** من استخدام **CSRF Tokens** لأنها قد تكون قابلة للتجاوز.

---

## **🛠 تجارب عملية لاختبار وسائل الحماية**

- 🔗 [**تجاوز حماية CSRF Token**](https://portswigger.net/web-security/csrf/bypassing-token-validation)
- 🔗 [**تجاوز قيود SameSite Cookies**](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions)
- 🔗 [**تجاوز آلية الحماية عبر Referer**](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)
---

📌 **للمزيد حول كيفية تطبيق هذه الوسائل بشكل صحيح، اطلع على:**  
🔗 [كيفية منع ثغرات CSRF](https://portswigger.net/web-security/csrf/preventing)

